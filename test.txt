# Base filename pattern
$baseFileName = "service-log"
$extension = ".txt"
$counter = 1

# Loop to find next available log file name
do {
    $logFile = Join-Path $logFolder ("{0}_{1}{2}" -f $baseFileName, $counter, $extension)
    $counter++
} while (Test-Path $logFile)



function Start-ServiceWithRetry {
    param (
        [string]$ServiceName,
        [int]$MaxAttempts = 3,
        [int]$RetryDelaySeconds = 3
    )

    $attempt = 1
    $success = $false

    while ($attempt -le $MaxAttempts -and -not $success) {
        try {
            $svc = Get-Service -Name $ServiceName -ErrorAction Stop

            if ($svc.Status -eq 'Running') {
                Write-Host "[INFO] '$ServiceName' is already running." -ForegroundColor Green
                return $true
            }

            Write-Host "[INFO] Attempt #$attempt to start '$ServiceName'" -ForegroundColor Cyan
            Start-Service -Name $ServiceName -ErrorAction Stop
            Start-Sleep -Seconds 2

            $svc.Refresh()
            if ($svc.Status -eq 'Running') {
                Write-Host "[SUCCESS] '$ServiceName' started successfully." -ForegroundColor Green
                $success = $true
                return $true
            } else {
                throw "Still not running (Status: $($svc.Status))"
            }
        }
        catch {
            Write-Host "[ERROR] Attempt #$attempt failed: $($_.Exception.Message)" -ForegroundColor Red
            $attempt++
            Start-Sleep -Seconds $RetryDelaySeconds
        }
    }

    Write-Host "[FAIL] '$ServiceName' failed to start after $MaxAttempts attempts." -ForegroundColor Red
    return $false
}

$servicesToStart = @('CBFTService1', 'FTUService2', 'FTUService3')

foreach ($svcName in $servicesToStart) {
    $result = Start-ServiceWithRetry -ServiceName $svcName

    if (-not $result) {
        # Optionally log to file here
        Write-Host "[WARN] Skipping '$svcName' after failures." -ForegroundColor Yellow
        continue
    }

    # Further actions if needed...
}


function Start-ServiceWithRetryAndTimeout {
    param (
        [string]$ServiceName,
        [int]$TimeoutSeconds = 30,
        [int]$MaxAttempts = 3,
        [int]$SleepBetweenRetries = 5
    )

    $attempt = 1
    while ($attempt -le $MaxAttempts) {
        Write-Host "`n--- Attempt $attempt to start service '$ServiceName' ---"

        # Fetch service object fresh each time
        $service = Get-Service -Name $ServiceName -ErrorAction SilentlyContinue
        if (-not $service) {
            Write-Warning "Service '$ServiceName' not found."
            return
        }

        if ($service.Status -eq 'Running') {
            Write-Host "Service '$ServiceName' is already running."
            return
        }

        try {
            Write-Host "Starting service..."
            Start-Service -Name $ServiceName -ErrorAction Stop
        } catch {
            Write-Warning "Start attempt failed: $_"
        }

        # Wait for the service to reach 'Running'
        $elapsed = 0
        while ($elapsed -lt $TimeoutSeconds) {
            Start-Sleep -Seconds 2
            $elapsed += 2
            $service.Refresh()

            if ($service.Status -eq 'Running') {
                Write-Host "✅ Service '$ServiceName' started successfully in $elapsed seconds."
                return
            } elseif ($service.Status -ne 'StartPending') {
                break
            }
        }

        $service.Refresh()
        if ($service.Status -eq 'Running') {
            Write-Host "✅ Service '$ServiceName' started successfully."
            return
        } elseif ($service.Status -eq 'StartPending') {
            Write-Warning "⏱ Service stuck in StartPending for $TimeoutSeconds seconds."
            try {
                Write-Host "Trying to force-stop stuck service..."
                Stop-Service -Name $ServiceName -Force -ErrorAction Stop
                Start-Sleep -Seconds 3
            } catch {
                Write-Warning "Could not stop stuck service: $_"
            }
        } else {
            Write-Warning "Service '$ServiceName' status is '$($service.Status)'. Retrying..."
        }

        $attempt++
        if ($attempt -le $MaxAttempts) {
            Write-Host "⏳ Waiting $SleepBetweenRetries seconds before retry..."
            Start-Sleep -Seconds $SleepBetweenRetries
        } else {
            Write-Error "❌ Failed to start service '$ServiceName' after $MaxAttempts attempts."
        }
    }
}
