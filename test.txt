# Base filename pattern
$baseFileName = "service-log"
$extension = ".txt"
$counter = 1

# Loop to find next available log file name
do {
    $logFile = Join-Path $logFolder ("{0}_{1}{2}" -f $baseFileName, $counter, $extension)
    $counter++
} while (Test-Path $logFile)



function Start-ServiceWithRetry {
    param (
        [string]$ServiceName,
        [int]$MaxAttempts = 3,
        [int]$RetryDelaySeconds = 3
    )

    $attempt = 1
    $success = $false

    while ($attempt -le $MaxAttempts -and -not $success) {
        try {
            $svc = Get-Service -Name $ServiceName -ErrorAction Stop

            if ($svc.Status -eq 'Running') {
                Write-Host "[INFO] '$ServiceName' is already running." -ForegroundColor Green
                return $true
            }

            Write-Host "[INFO] Attempt #$attempt to start '$ServiceName'" -ForegroundColor Cyan
            Start-Service -Name $ServiceName -ErrorAction Stop
            Start-Sleep -Seconds 2

            $svc.Refresh()
            if ($svc.Status -eq 'Running') {
                Write-Host "[SUCCESS] '$ServiceName' started successfully." -ForegroundColor Green
                $success = $true
                return $true
            } else {
                throw "Still not running (Status: $($svc.Status))"
            }
        }
        catch {
            Write-Host "[ERROR] Attempt #$attempt failed: $($_.Exception.Message)" -ForegroundColor Red
            $attempt++
            Start-Sleep -Seconds $RetryDelaySeconds
        }
    }

    Write-Host "[FAIL] '$ServiceName' failed to start after $MaxAttempts attempts." -ForegroundColor Red
    return $false
}

$servicesToStart = @('CBFTService1', 'FTUService2', 'FTUService3')

foreach ($svcName in $servicesToStart) {
    $result = Start-ServiceWithRetry -ServiceName $svcName

    if (-not $result) {
        # Optionally log to file here
        Write-Host "[WARN] Skipping '$svcName' after failures." -ForegroundColor Yellow
        continue
    }

    # Further actions if needed...
}


# Max width for service name
$maxNameLength = 35

$filtered | ForEach-Object {
    $name = $_.Name
    $state = $_.State
    $startMode = $_.StartMode

    # Truncate service name if too long
    if ($name.Length -gt $maxNameLength) {
        $name = $name.Substring(0, $maxNameLength - 3) + "..."
    }

    # Format line with clean alignment
    $line = "{0,-" + $maxNameLength + "} | Status: {1,-10} | Startup: {2}" -f $name, $state, $startMode

    Write-Host $line
    Add-Content -Path $summaryFile -Value $line
}
